name: Build IDA Pro SigMaker

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-plugin:
    runs-on: windows-latest

    steps:
      # 1. 检出插件源码
      - name: Checkout Plugin Code
        uses: actions/checkout@v4

      # 2. 检出 IDA SDK 到 SDK 目录
      # 注意：根据日志，项目期望 SDK 在 "SDK" 文件夹中，而不是 "idasdk9"
      - name: Checkout IDA SDK
        uses: actions/checkout@v4
        with:
          repository: shefben/ida_sdk_91
          path: SDK

      # 3. 配置 MSBuild 环境
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # 4. [关键修复] 自动修补 Main.cpp 以适配 IDA 9 SDK
      # 错误原因: 'bin_search3' 在 IDA 9 中被移除，需替换为 'bin_search' 且参数顺序不同。
      # 旧: bin_search3(&idx, start, end, pats, flags)
      # 新: bin_search(start, end, pats, flags, &idx)
      - name: Patch Main.cpp for IDA 9
        shell: bash
        run: |
          echo "Patching bin_search3 to bin_search in Main.cpp..."
          # 使用正则调整参数顺序 (将第一个参数移到最后)
          sed -i -E 's/bin_search3\s*\(\s*([^,]+),\s*([^,]+),\s*([^,]+),\s*([^,]+),\s*([^)]+)\)/bin_search(\2, \3, \4, \5, \1)/g' "IDA Pro SigMaker/Main.cpp"
          
          # 打印包含 bin_search 的行以确认修改成功
          grep "bin_search" "IDA Pro SigMaker/Main.cpp" || echo "Patch might have failed or line looks different."

      # 5. 运行 MSBuild 编译
      - name: Build Solution
        run: msbuild /m /p:Configuration="IDA Plugin (64-Bit)" /p:Platform=x64 "IDA Pro SigMaker.sln"

      # 6. 上传生成的 DLL
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: IDA_Pro_SigMaker_Plugin
          path: |
            **/*.dll
            **/*.pdb
          if-no-files-found: error
