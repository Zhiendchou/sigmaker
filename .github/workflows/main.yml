name: Build SigMaker (DLL)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: "IDA Pro SigMaker.sln" # 根据你的日志，sln似乎在子目录，请确认
  # 修正点：使用 sln 中实际存在的配置名称，注意保留双引号
  BUILD_CONFIGURATION: "IDA Plugin (64-Bit)"
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      # 如果 sln 在子目录，这里可能需要调整路径，或者直接对 sln 所在的目录 restore
      run: nuget restore "${{ env.SOLUTION_FILE_PATH }}"

    - name: Build Solution
      # 注意：Configuration 参数加了引号，因为名字里有空格
      run: |
        msbuild /m /p:Configuration="${{ env.BUILD_CONFIGURATION }}" /p:Platform=${{ env.BUILD_PLATFORM }} "${{ env.SOLUTION_FILE_PATH }}"

    - name: Locate Output Files
      id: locate_artifacts
      shell: pwsh
      run: |
        # 查找生成的 .dll (通常在 x64/IDA Plugin (64-Bit)/ 下)
        $dllPath = Get-ChildItem -Path . -Recurse -Filter "*.dll" | Where-Object { $_.FullName -notmatch "\\obj\\" } | Select-Object -First 1
        
        if ($dllPath) {
          echo "Found DLL: $($dllPath.FullName)"
          echo "dll_path=$($dllPath.FullName)" >> $env:GITHUB_OUTPUT
          echo "dll_name=$($dllPath.Name)" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "No DLL found! Build might have failed silently or output path is unusual."
          exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SigMaker-Plugin
        path: ${{ steps.locate_artifacts.outputs.dll_path }}
        if-no-files-found: error
