name: Build SigMaker (DLL)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  # 你的 .sln 路径
  SOLUTION_FILE_PATH: "IDA Pro SigMaker.sln"
  # 使用 sln 中实际存在的配置名称
  BUILD_CONFIGURATION: "IDA Plugin (64-Bit)"
  BUILD_PLATFORM: x64

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ------------------------------------------------------------------
    # [新增步骤] 下载 IDA SDK
    # 将 SDK clone 到项目期望的目录 "SDK"
    # 项目设置里引用路径是 "..\SDK\include"，所以放在根目录即可
    # ------------------------------------------------------------------
    - name: Setup IDA SDK
      run: |
        git clone https://github.com/shefben/ida_sdk_91 SDK

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore "${{ env.SOLUTION_FILE_PATH }}"

    - name: Build Solution
      # Configuration 名称包含空格，必须加引号
      run: |
        msbuild /m /p:Configuration="${{ env.BUILD_CONFIGURATION }}" /p:Platform=${{ env.BUILD_PLATFORM }} "${{ env.SOLUTION_FILE_PATH }}"

    - name: Locate Output Files
      id: locate_artifacts
      shell: pwsh
      run: |
        # 查找生成的 .dll (通常在 x64/IDA Plugin (64-Bit)/ 下)
        # 排除 obj 文件夹防止误报
        $dllPath = Get-ChildItem -Path . -Recurse -Filter "*.dll" | Where-Object { $_.FullName -notmatch "\\obj\\" } | Select-Object -First 1
        
        if ($dllPath) {
          echo "Found DLL: $($dllPath.FullName)"
          echo "dll_path=$($dllPath.FullName)" >> $env:GITHUB_OUTPUT
          echo "dll_name=$($dllPath.Name)" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "No DLL found! Build might have failed silently or output path is unusual."
          exit 1
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SigMaker-Plugin-x64
        path: ${{ steps.locate_artifacts.outputs.dll_path }}
        if-no-files-found: error
